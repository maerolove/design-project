# STATE MACHINE ASYNC CONTRACT
## КОНТРАКТ АСИНХРОННОЙ СТЕЙТ-МАШИНЫ

### ОСНОВНОЙ ПРИНЦИП
**СТРОГО АСИНХРОННАЯ ИНИЦИАЛИЗАЦИЯ С ЗАГРУЗКОЙ XML**

### АРХИТЕКТУРНЫЕ ПРАВИЛА

#### 1. ЕДИНСТВЕННЫЙ ИСТОЧНИК ИСТИНЫ
- **XML файл** `/shared/stateMachineSimplified.xml` - единственный источник истины
- **ЗАПРЕЩЕНО** дублирование данных в коде
- **ЗАПРЕЩЕНО** встроенные данные в JavaScript
- **ЗАПРЕЩЕНО** fallback данные с неполной структурой

#### 2. АСИНХРОННАЯ ИНИЦИАЛИЗАЦИЯ
- **ВСЕ** операции инициализации стейт-машины должны быть асинхронными
- **ЗАПРЕЩЕНО** синхронная инициализация при импорте модуля
- **ЗАПРЕЩЕНО** вызов `initializeStateMachine()` сразу при импорте
- **ОБЯЗАТЕЛЬНО** ожидание загрузки XML перед инициализацией

#### 3. ПОСЛЕДОВАТЕЛЬНОСТЬ ИНИЦИАЛИЗАЦИИ
```
1. Импорт модуля → НЕ инициализирует стейт-машину
2. Загрузка XML файла → Асинхронная операция
3. Парсинг XML → Создание структуры данных
4. Валидация данных → Проверка корректности
5. Создание парсера → StateMachineParser
6. Создание менеджера → StateMachineManager
7. Готовность стейт-машины → isReady = true
```

#### 4. ОБРАБОТКА ОШИБОК
- **ЗАПРЕЩЕНО** fallback данные с неполной структурой
- **ЗАПРЕЩЕНО** скрытие ошибок инициализации
- **ОБЯЗАТЕЛЬНО** явная обработка ошибок загрузки XML
- **ОБЯЗАТЕЛЬНО** явная обработка ошибок парсинга XML
- **ОБЯЗАТЕЛЬНО** явная обработка ошибок валидации

#### 5. СОСТОЯНИЯ ГОТОВНОСТИ
- **isReady()** - проверка готовности стейт-машины
- **getInitError()** - получение ошибки инициализации
- **getStateMachineManager()** - получение менеджера (только если готов)
- **getStateMachineManagerAsync()** - асинхронное получение менеджера

#### 6. ИНТЕГРАЦИЯ С ХУКАМИ
- **useStateMachine** должен проверять `isReady()` перед использованием
- **useApiOperations** должен проверять `isReady()` перед операциями
- **ЗАПРЕЩЕНО** использование стейт-машины до готовности

#### 7. ИНТЕГРАЦИЯ С КОМПОНЕНТАМИ
- **ВСЕ** компоненты должны проверять готовность стейт-машины
- **ОБЯЗАТЕЛЬНО** показ состояния загрузки до готовности
- **ОБЯЗАТЕЛЬНО** показ ошибок инициализации

### ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

#### 1. StateMachineXMLSyncLoader
- **ПЕРЕИМЕНОВАТЬ** в `StateMachineXMLAsyncLoader`
- **УБРАТЬ** синхронные методы
- **ДОБАВИТЬ** асинхронные методы загрузки
- **ДОБАВИТЬ** методы проверки готовности

#### 2. index.js
- **УБРАТЬ** синхронную инициализацию при импорте
- **ДОБАВИТЬ** асинхронную инициализацию
- **ДОБАВИТЬ** методы проверки готовности
- **УБРАТЬ** fallback данные

#### 3. useStateMachine.js
- **ДОБАВИТЬ** проверку готовности стейт-машины
- **ДОБАВИТЬ** состояние загрузки
- **ДОБАВИТЬ** обработку ошибок инициализации

#### 4. useApiOperations.js
- **ДОБАВИТЬ** проверку готовности перед операциями
- **ДОБАВИТЬ** обработку ошибок инициализации

### ПРИМЕРЫ ПРАВИЛЬНОЙ РЕАЛИЗАЦИИ

#### Правильная инициализация:
```javascript
// В index.js
let isInitialized = false;
let initError = null;

async function initializeStateMachine() {
  if (isInitialized) return stateMachineManager;
  
  try {
    // 1. Загрузка XML
    const xmlData = await loadXMLFile();
    
    // 2. Парсинг XML
    const machineData = parseXML(xmlData);
    
    // 3. Валидация
    validateData(machineData);
    
    // 4. Создание парсера и менеджера
    parser = new StateMachineParser(machineData);
    stateMachineManager = new StateMachineManager(parser);
    
    isInitialized = true;
    return stateMachineManager;
  } catch (error) {
    initError = error;
    throw error; // НЕ скрываем ошибку!
  }
}

// НЕ вызываем initializeStateMachine() при импорте!
```

#### Правильное использование в хуках:
```javascript
// В useStateMachine.js
useEffect(() => {
  const initStateMachine = async () => {
    try {
      if (!isStateMachineReady()) {
        await initializeStateMachine();
      }
      // Используем стейт-машину
    } catch (error) {
      setInitError(error);
    }
  };
  
  initStateMachine();
}, []);
```

### ЗАПРЕЩЕННЫЕ ПАТТЕРНЫ

#### ❌ НЕПРАВИЛЬНО:
```javascript
// Синхронная инициализация при импорте
try {
  initializeStateMachine(); // ОШИБКА!
} catch (error) {
  // Fallback с неполными данными - ОШИБКА!
}
```

#### ❌ НЕПРАВИЛЬНО:
```javascript
// Fallback данные
const fallbackData = {
  states: { "INITIAL": "initial", "COMPILED": "compiled" }
  // Только 2 состояния вместо 10 - ОШИБКА!
};
```

#### ❌ НЕПРАВИЛЬНО:
```javascript
// Использование без проверки готовности
const manager = getStateMachineManager(); // ОШИБКА!
```

### РАЗРЕШЕННЫЕ ПАТТЕРНЫ

#### ✅ ПРАВИЛЬНО:
```javascript
// Асинхронная инициализация
await initializeStateMachine();
```

#### ✅ ПРАВИЛЬНО:
```javascript
// Проверка готовности
if (isStateMachineReady()) {
  const manager = getStateMachineManager();
}
```

#### ✅ ПРАВИЛЬНО:
```javascript
// Обработка ошибок
try {
  await initializeStateMachine();
} catch (error) {
  setInitError(error); // НЕ скрываем ошибку!
}
```

### КОНТРОЛЬНЫЕ ТОЧКИ

1. **XML файл загружается** асинхронно
2. **Стейт-машина инициализируется** только после загрузки XML
3. **Нет fallback данных** с неполной структурой
4. **Ошибки инициализации** не скрываются
5. **Хуки проверяют готовность** перед использованием
6. **Компоненты показывают состояние** загрузки/ошибки

### НАРУШЕНИЯ КОНТРАКТА

**КРИТИЧЕСКИЕ НАРУШЕНИЯ:**
- Синхронная инициализация при импорте
- Fallback данные с неполной структурой
- Скрытие ошибок инициализации
- Использование стейт-машины до готовности

**ПОСЛЕДСТВИЯ НАРУШЕНИЙ:**
- Нестабильная работа стейт-машины
- Неполные данные состояний
- Скрытые ошибки инициализации
- Проблемы с переходами состояний

### ОБНОВЛЕНИЯ КОНТРАКТА

**ВЕРСИЯ:** 1.0.0
**ДАТА:** 2024-12-19
**СТАТУС:** АКТИВНЫЙ

**ИЗМЕНЕНИЯ:**
- Убраны встроенные данные
- Добавлена строгая асинхронная инициализация
- Убраны fallback данные
- Добавлена явная обработка ошибок